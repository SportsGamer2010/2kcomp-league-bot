"""Notification management commands."""

import logging
from typing import Optional

import discord
from discord.ext import commands
from discord import app_commands

from core.config import settings

logger = logging.getLogger(__name__)


class NotificationsCog(commands.Cog):
    """Notification management commands."""
    
    def __init__(self, bot: commands.Bot):
        self.bot = bot
    
    def has_admin_role(self, user: discord.Member) -> bool:
        """Check if user has admin role."""
        if not user or not hasattr(user, 'roles'):
            return False
        return any(role.name == settings.ADMIN_ROLE for role in user.roles)
    
    @app_commands.command(name="notifications", description="Manage notification system")
    @app_commands.describe(
        action="Action to perform",
        message="Custom message for manual notification (optional)"
    )
    @app_commands.choices(action=[
        app_commands.Choice(name="Status", value="status"),
        app_commands.Choice(name="Test", value="test"),
        app_commands.Choice(name="Weekly Summary", value="weekly"),
        app_commands.Choice(name="Manual Alert", value="manual")
    ])
    async def notifications(
        self,
        interaction: discord.Interaction,
        action: str,
        message: Optional[str] = None
    ):
        """Manage the notification system."""
        # Check permissions
        if not self.has_admin_role(interaction.user):
            await interaction.response.send_message(
                f"‚ùå You need the '{settings.ADMIN_ROLE}' role to use this command.",
                ephemeral=True
            )
            return
        
        await interaction.response.defer()
        
        try:
            if action == "status":
                await self._show_notification_status(interaction)
            elif action == "test":
                await self._test_notification_system(interaction)
            elif action == "weekly":
                await self._send_weekly_summary(interaction)
            elif action == "manual":
                await self._send_manual_alert(interaction, message)
            else:
                await interaction.followup.send(
                    "‚ùå Invalid action. Use: status, test, weekly, or manual",
                    ephemeral=True
                )
                
        except Exception as e:
            logger.error(f"Error in notifications command: {e}")
            await interaction.followup.send(
                "‚ùå An error occurred while processing the notification command.",
                ephemeral=True
            )
    
    async def _show_notification_status(self, interaction: discord.Interaction):
        """Show notification system status."""
        try:
            # Get announce channel
            channel = self.bot.get_channel(settings.ANNOUNCE_CHANNEL_ID)
            channel_status = "‚úÖ Connected" if channel else "‚ùå Not Found"
            
            # Create status embed
            embed = discord.Embed(
                title="üîî Notification System Status",
                description="Current status of the notification system",
                color=0x0099ff,
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(
                name="üì¢ Announce Channel",
                value=f"{channel_status}\nChannel ID: {settings.ANNOUNCE_CHANNEL_ID}",
                inline=True
            )
            
            embed.add_field(
                name="ü§ñ Bot Status",
                value=f"‚úÖ Online\nUptime: {self._get_uptime()}",
                inline=True
            )
            
            embed.add_field(
                name="üìä Monitoring",
                value="‚úÖ Active\n‚Ä¢ Game Events\n‚Ä¢ Stat Milestones\n‚Ä¢ Record Breakers\n‚Ä¢ Weekly Summaries",
                inline=False
            )
            
            embed.add_field(
                name="üéØ Milestone Thresholds",
                value="‚Ä¢ Points: 20, 30, 40, 50, 60, 70+\n‚Ä¢ Assists: 10, 15, 20, 25+\n‚Ä¢ Rebounds: 10, 15, 20, 25, 30+\n‚Ä¢ Steals: 5, 7, 10+\n‚Ä¢ Blocks: 3, 5, 7, 10+\n‚Ä¢ 3PM: 5, 7, 10, 15+",
                inline=False
            )
            
            embed.add_field(
                name="üî• Record Alerts",
                value="‚Ä¢ 50+ Points\n‚Ä¢ 20+ Assists\n‚Ä¢ 20+ Rebounds\n‚Ä¢ 8+ Steals\n‚Ä¢ 5+ Blocks\n‚Ä¢ 10+ 3-Pointers",
                inline=False
            )
            
            embed.set_footer(text="2KCompLeague | Notification System")
            
            await interaction.followup.send(embed=embed)
            
        except Exception as e:
            logger.error(f"Error showing notification status: {e}")
            await interaction.followup.send(
                "‚ùå Error retrieving notification status.",
                ephemeral=True
            )
    
    async def _test_notification_system(self, interaction: discord.Interaction):
        """Test the notification system with a sample notification."""
        try:
            # Get announce channel
            channel = self.bot.get_channel(settings.ANNOUNCE_CHANNEL_ID)
            if not channel:
                await interaction.followup.send(
                    "‚ùå Announce channel not found. Please check configuration.",
                    ephemeral=True
                )
                return
            
            # Create test embed
            embed = discord.Embed(
                title="üß™ Test Notification",
                description="This is a test of the notification system!",
                color=0x00FF00,
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(
                name="‚úÖ System Check",
                value="‚Ä¢ Notification system is working\n‚Ä¢ Channel connectivity confirmed\n‚Ä¢ Embed formatting successful",
                inline=False
            )
            
            embed.add_field(
                name="üìä What to Expect",
                value="‚Ä¢ Real-time stat milestone alerts\n‚Ä¢ Record-breaking notifications\n‚Ä¢ Weekly league summaries\n‚Ä¢ Game event updates",
                inline=False
            )
            
            embed.set_footer(text="2KCompLeague | Test Notification")
            
            # Send test notification
            await channel.send(embed=embed)
            
            await interaction.followup.send(
                "‚úÖ Test notification sent successfully!",
                ephemeral=True
            )
            
        except Exception as e:
            logger.error(f"Error testing notification system: {e}")
            await interaction.followup.send(
                "‚ùå Error sending test notification.",
                ephemeral=True
            )
    
    async def _send_weekly_summary(self, interaction: discord.Interaction):
        """Manually send a weekly summary."""
        try:
            # Get announce channel
            channel = self.bot.get_channel(settings.ANNOUNCE_CHANNEL_ID)
            if not channel:
                await interaction.followup.send(
                    "‚ùå Announce channel not found.",
                    ephemeral=True
                )
                return
            
            # Create weekly summary embed
            embed = discord.Embed(
                title="üìä Weekly League Summary",
                description="Here's what happened in 2KCompLeague this week!",
                color=0x0099ff,
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(
                name="üèÄ Top Performers",
                value="‚Ä¢ Check `/leaders season` for this week's top performers\n‚Ä¢ Use `/leaders career` for all-time leaders",
                inline=False
            )
            
            embed.add_field(
                name="üî• Record Breakers",
                value="‚Ä¢ Check `/records` for all-time single-game records\n‚Ä¢ New records are highlighted in real-time!",
                inline=False
            )
            
            embed.add_field(
                name="üìà League Standings",
                value="‚Ä¢ Check the [Season 1 Standings](https://2kcompleague.com/table/nba2k26-season-1-standings/)\n‚Ä¢ Season starts October 1st!",
                inline=False
            )
            
            embed.add_field(
                name="üìä Season Stats",
                value="‚Ä¢ View [Season 1 Stats](https://2kcompleague.com/list/nba2k26-season-1-stats/)\n‚Ä¢ Track your progress throughout the season!",
                inline=False
            )
            
            embed.set_footer(text="2KCompLeague | Powered by SportsPress")
            
            # Send weekly summary
            await channel.send(embed=embed)
            
            await interaction.followup.send(
                "‚úÖ Weekly summary sent successfully!",
                ephemeral=True
            )
            
        except Exception as e:
            logger.error(f"Error sending weekly summary: {e}")
            await interaction.followup.send(
                "‚ùå Error sending weekly summary.",
                ephemeral=True
            )
    
    async def _send_manual_alert(self, interaction: discord.Interaction, message: Optional[str]):
        """Send a manual alert notification."""
        try:
            if not message:
                await interaction.followup.send(
                    "‚ùå Please provide a message for the manual alert.",
                    ephemeral=True
                )
                return
            
            # Get announce channel
            channel = self.bot.get_channel(settings.ANNOUNCE_CHANNEL_ID)
            if not channel:
                await interaction.followup.send(
                    "‚ùå Announce channel not found.",
                    ephemeral=True
                )
                return
            
            # Create manual alert embed
            embed = discord.Embed(
                title="üì¢ Manual Alert",
                description=message,
                color=0xFF6B35,  # Orange
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(
                name="üë§ Sent By",
                value=f"{interaction.user.display_name}",
                inline=True
            )
            
            embed.set_footer(text="2KCompLeague | Manual Alert")
            
            # Send manual alert
            await channel.send(embed=embed)
            
            await interaction.followup.send(
                "‚úÖ Manual alert sent successfully!",
                ephemeral=True
            )
            
        except Exception as e:
            logger.error(f"Error sending manual alert: {e}")
            await interaction.followup.send(
                "‚ùå Error sending manual alert.",
                ephemeral=True
            )
    
    def _get_uptime(self) -> str:
        """Get bot uptime."""
        try:
            uptime = discord.utils.utcnow() - self.bot.start_time
            days = uptime.days
            hours, remainder = divmod(uptime.seconds, 3600)
            minutes, _ = divmod(remainder, 60)
            
            if days > 0:
                return f"{days}d {hours}h {minutes}m"
            elif hours > 0:
                return f"{hours}h {minutes}m"
            else:
                return f"{minutes}m"
        except:
            return "Unknown"


async def setup(bot: commands.Bot):
    """Set up the notifications cog."""
    await bot.add_cog(NotificationsCog(bot))
    logger.info("Notifications cog loaded")
